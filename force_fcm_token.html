<!DOCTYPE html>
<html>
<head>
    <title>Forcer g√©n√©ration Token FCM</title>
</head>
<body>
    <h1>üîë G√©n√©rer Token FCM</h1>
    
    <button onclick="testButton()">üß™ Test Bouton</button>
    <button onclick="checkPermissions()">üîî V√©rifier Permissions</button>
    <button onclick="generateFCMToken()">üöÄ G√©n√©rer Token FCM</button>
    <div id="result"></div>

    <script>
        function testButton() {
            document.getElementById('result').innerHTML = '<p style="color: green;">‚úÖ JavaScript fonctionne !</p>';
        }

        function checkPermissions() {
            const result = document.getElementById('result');
            if ('Notification' in window) {
                result.innerHTML = `<p>üîî Support notifications: ‚úÖ</p><p>Permission actuelle: ${Notification.permission}</p>`;
            } else {
                result.innerHTML = '<p style="color: red;">‚ùå Notifications non support√©es</p>';
            }
        }

        async function generateFCMToken() {
            const result = document.getElementById('result');
            result.innerHTML = '<p>‚è≥ Tentative de g√©n√©ration FCM token...</p>';
            
            try {
                // Test if Firebase is available
                if (typeof importScripts === 'undefined') {
                    // We're in main thread, use dynamic import
                    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
                    const { getMessaging, getToken } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging.js');
                    
                    const firebaseConfig = {
                        apiKey: "AIzaSyCdJSoFjbBqFtxxrIRV2zc7ow_UmdC5U",
                        authDomain: "dailygrowth-pwa.firebaseapp.com",
                        projectId: "dailygrowth-pwa",
                        storageBucket: "dailygrowth-pwa.appspot.com",
                        messagingSenderId: "443167745906",
                        appId: "1:443167745906:web:c0e8f1c03571d440f3dfeb",
                        measurementId: "G-BXJW80Y4EF"
                    };

                    const app = initializeApp(firebaseConfig);
                    const messaging = getMessaging(app);

                    // Request permission first
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        result.innerHTML = '<p style="color: red;">‚ùå Permission refus√©e. Accorde les permissions.</p>';
                        return;
                    }

                    // Get FCM token
                    const token = await getToken(messaging, {
                        vapidKey: 'BJe790aSYySweHjaldtDhKaWTx5BBQ0dskvXly3urJWFnFifeoWY1EA8wJnDvyUhIu_s_AZODY9ucqBi0FgMxXs'
                    });

                    if (token) {
                        localStorage.setItem('fcm_token', token);
                        
                        result.innerHTML = `
                            <div style="background: #d4edda; padding: 15px; border-radius: 5px; margin-top: 10px;">
                                <h3 style="color: #155724;">‚úÖ Token FCM G√©n√©r√© !</h3>
                                <p><strong>Token (tronqu√©):</strong><br>${token.substring(0, 50)}...${token.substring(token.length - 20)}</p>
                                <h4>üìã Token complet (copie-le) :</h4>
                                <textarea style="width: 100%; height: 120px; font-family: monospace; font-size: 11px;" readonly onclick="this.select()">${token}</textarea>
                                <br><br>
                                <p style="background: #fff3cd; padding: 10px; border-radius: 5px;"><strong>üîß SQL √† ex√©cuter dans Supabase :</strong></p>
                                <textarea style="width: 100%; height: 80px; font-family: monospace; font-size: 11px;" readonly onclick="this.select()">UPDATE user_profiles SET fcm_token = '${token}', reminder_notifications_enabled = true WHERE email = 'expertiaen5min@gmail.com';</textarea>
                            </div>
                        `;
                        
                        console.log('üîë FCM Token:', token);
                    } else {
                        result.innerHTML = '<p style="color: orange;">‚ö†Ô∏è Aucun token g√©n√©r√©. V√©rifie les permissions.</p>';
                    }
                } else {
                    result.innerHTML = '<p style="color: red;">‚ùå Environnement non support√©</p>';
                }
            } catch (error) {
                result.innerHTML = `<p style="color: red;">‚ùå Erreur: ${error.message}</p>`;
                console.error('Erreur FCM:', error);
            }
        }
    </script>
</body>
</html>