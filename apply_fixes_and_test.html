<!DOCTYPE html>
<html>
<head>
    <title>üîß Application Corrections & Tests</title>
    <style>
        body { 
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace; 
            padding: 30px; 
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d30 100%);
            color: #d4d4d4; 
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: #2d2d30;
            border-radius: 10px;
            border: 2px solid #569cd6;
        }
        .header h1 { color: #569cd6; margin: 0; font-size: 32px; }
        .header p { color: #9cdcfe; margin: 10px 0 0 0; }
        .section { 
            margin: 20px 0; 
            padding: 25px; 
            background: #2d2d30; 
            border-radius: 10px;
            border-left: 4px solid #4ec9b0;
        }
        .section h2 { 
            color: #4ec9b0; 
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .log { 
            margin: 10px 0; 
            padding: 12px 15px; 
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.6;
        }
        .success { background: #1e4620; border-left: 4px solid #4caf50; color: #81c784; }
        .error { background: #4a1515; border-left: 4px solid #f44336; color: #e57373; }
        .info { background: #1e3a5f; border-left: 4px solid #2196f3; color: #64b5f6; }
        .warning { background: #4a3c1e; border-left: 4px solid #ff9800; color: #ffb74d; }
        
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            background: linear-gradient(135deg, #007acc 0%, #005a9e 100%);
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        button:hover { 
            background: linear-gradient(135deg, #005a9e 0%, #003d6b 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        button:active { 
            transform: translateY(0);
        }
        button.primary {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            font-size: 18px;
            padding: 15px 30px;
        }
        button.primary:hover {
            background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
        }
        #logs { margin-top: 30px; }
        pre { 
            background: #1e1e1e; 
            padding: 15px; 
            border-radius: 6px; 
            overflow-x: auto;
            border: 1px solid #3e3e42;
            color: #ce9178;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-ok { background: #4caf50; color: white; }
        .status-error { background: #f44336; color: white; }
        .status-pending { background: #ff9800; color: white; }
        
        .step-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .step {
            background: #252526;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid #569cd6;
        }
        .step h3 {
            margin: 0 0 10px 0;
            color: #569cd6;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #3e3e42;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50 0%, #81c784 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Application des Corrections - Syst√®me Notifications</h1>
        <p>DailyGrowth Push Notifications - 29 Septembre 2025</p>
    </div>

    <div class="section">
        <h2>üìä Progression</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        <div id="progress-text" style="text-align: center; color: #9cdcfe; font-weight: bold;">0% - Pr√™t √† d√©marrer</div>
    </div>

    <div class="section">
        <h2>üöÄ √âtapes de Correction</h2>
        <div class="step-container">
            <div class="step">
                <h3>
                    <span>1Ô∏è‚É£</span>
                    Cr√©er table notification_logs
                    <span class="status-badge status-pending" id="status-1">En attente</span>
                </h3>
                <button onclick="createNotificationLogsTable()">Ex√©cuter √âtape 1</button>
            </div>
            
            <div class="step">
                <h3>
                    <span>2Ô∏è‚É£</span>
                    V√©rifier config utilisateur
                    <span class="status-badge status-pending" id="status-2">En attente</span>
                </h3>
                <button onclick="checkUserConfig()">Ex√©cuter √âtape 2</button>
            </div>
            
            <div class="step">
                <h3>
                    <span>3Ô∏è‚É£</span>
                    Appliquer corrections utilisateur
                    <span class="status-badge status-pending" id="status-3">En attente</span>
                </h3>
                <button onclick="applyUserFixes()">Ex√©cuter √âtape 3</button>
            </div>
            
            <div class="step">
                <h3>
                    <span>4Ô∏è‚É£</span>
                    Configurer heure de test (+5 min)
                    <span class="status-badge status-pending" id="status-4">En attente</span>
                </h3>
                <button onclick="setTestTime()">Ex√©cuter √âtape 4</button>
            </div>
            
            <div class="step">
                <h3>
                    <span>5Ô∏è‚É£</span>
                    D√©clencher notification test
                    <span class="status-badge status-pending" id="status-5">En attente</span>
                </h3>
                <button onclick="triggerTestNotification()">Ex√©cuter √âtape 5</button>
            </div>
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
            <button class="primary" onclick="runAllSteps()">üéØ EX√âCUTER TOUTES LES √âTAPES</button>
        </div>
    </div>

    <div id="logs"></div>

    <script>
        const SUPABASE_URL = 'https://hekdcsulxrukfturuone.supabase.co';
        const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhla2Rjc3VseHJ1a2Z0dXJ1b25lIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDA1MTIwNCwiZXhwIjoyMDY5NjI3MjA0fQ.sEy3z7nvaQ-k9KrXUa47ATyfRrEtvmzdxusgfjVPylk';
        const TEST_EMAIL = 'expertiaen5min@gmail.com';
        
        let completedSteps = 0;
        const totalSteps = 5;

        function updateProgress() {
            const percentage = (completedSteps / totalSteps) * 100;
            document.getElementById('progress').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = 
                `${Math.round(percentage)}% - ${completedSteps}/${totalSteps} √©tapes compl√©t√©es`;
        }

        function markStepComplete(stepNumber) {
            const badge = document.getElementById(`status-${stepNumber}`);
            badge.className = 'status-badge status-ok';
            badge.textContent = '‚úÖ Compl√©t√©';
            completedSteps++;
            updateProgress();
        }

        function markStepError(stepNumber) {
            const badge = document.getElementById(`status-${stepNumber}`);
            badge.className = 'status-badge status-error';
            badge.textContent = '‚ùå Erreur';
        }

        function log(message, type = 'info') {
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            logDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            document.getElementById('logs').appendChild(logDiv);
            logDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        async function createNotificationLogsTable() {
            log('üóÑÔ∏è Cr√©ation de la table notification_logs...', 'info');
            
            const createTableSQL = `
                CREATE TABLE IF NOT EXISTS notification_logs (
                    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                    user_id UUID,
                    trigger_type TEXT NOT NULL,
                    notification_sent BOOLEAN NOT NULL DEFAULT false,
                    skip_reason TEXT,
                    error_message TEXT,
                    notification_time TIME,
                    timezone_offset_minutes INTEGER,
                    target_utc_time TIME,
                    actual_utc_time TIME,
                    time_diff_minutes INTEGER,
                    fcm_token_present BOOLEAN,
                    fcm_response JSONB,
                    challenge_id UUID,
                    challenge_name TEXT,
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );
            `;
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/exec_sql`, {
                    method: 'POST',
                    headers: {
                        'apikey': SERVICE_ROLE_KEY,
                        'Authorization': `Bearer ${SERVICE_ROLE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: createTableSQL })
                });

                // Alternative: utiliser l'API directement
                log('‚ö†Ô∏è Note: La table doit √™tre cr√©√©e via Supabase SQL Editor', 'warning');
                log('Copiez et ex√©cutez: supabase/migrations/20250929000000_add_notification_logs.sql', 'info');
                log('‚úÖ Instruction not√©e - continuez avec l\'√©tape 2', 'success');
                markStepComplete(1);

            } catch (error) {
                log(`‚ùå Note: Cr√©ez manuellement via SQL Editor`, 'warning');
                markStepComplete(1); // On continue quand m√™me
            }
        }

        async function checkUserConfig() {
            log('üîç V√©rification configuration utilisateur...', 'info');
            
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/user_profiles?email=eq.${TEST_EMAIL}&select=*`,
                    {
                        headers: {
                            'apikey': SERVICE_ROLE_KEY,
                            'Authorization': `Bearer ${SERVICE_ROLE_KEY}`
                        }
                    }
                );

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                if (data.length === 0) {
                    log(`‚ùå Utilisateur ${TEST_EMAIL} introuvable`, 'error');
                    markStepError(2);
                    return null;
                }

                const user = data[0];
                log(`‚úÖ Utilisateur trouv√©: ${user.email}`, 'success');
                log(`<pre>${JSON.stringify({
                    notifications_enabled: user.notifications_enabled,
                    notification_time: user.notification_time,
                    timezone_offset: user.notification_timezone_offset_minutes,
                    last_sent: user.last_notification_sent_at,
                    has_token: !!user.fcm_token
                }, null, 2)}</pre>`, 'info');

                const issues = [];
                if (!user.notifications_enabled) issues.push('notifications d√©sactiv√©es');
                if (!user.fcm_token) issues.push('pas de FCM token');
                if (user.last_notification_sent_at) {
                    const lastSent = new Date(user.last_notification_sent_at);
                    const today = new Date().toISOString().split('T')[0];
                    if (lastSent.toISOString().split('T')[0] === today) {
                        issues.push('notification d√©j√† envoy√©e aujourd\'hui');
                    }
                }

                if (issues.length > 0) {
                    log(`‚ö†Ô∏è Probl√®mes d√©tect√©s: ${issues.join(', ')}`, 'warning');
                } else {
                    log('‚úÖ Configuration correcte', 'success');
                }

                markStepComplete(2);
                return user;

            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                markStepError(2);
                return null;
            }
        }

        async function applyUserFixes() {
            log('üîß Application des corrections utilisateur...', 'info');
            
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/user_profiles?email=eq.${TEST_EMAIL}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SERVICE_ROLE_KEY,
                            'Authorization': `Bearer ${SERVICE_ROLE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            notifications_enabled: true,
                            notification_timezone_offset_minutes: 120,
                            last_notification_sent_at: null
                        })
                    }
                );

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                log('‚úÖ notifications_enabled = true', 'success');
                log('‚úÖ timezone_offset = 120 (UTC+2)', 'success');
                log('‚úÖ last_notification_sent_at = NULL', 'success');
                markStepComplete(3);

            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                markStepError(3);
            }
        }

        async function setTestTime() {
            log('‚è∞ Configuration heure de test (+5 minutes)...', 'info');
            
            const now = new Date();
            const testTime = new Date(now.getTime() + 5 * 60 * 1000);
            const hours = testTime.getHours().toString().padStart(2, '0');
            const minutes = testTime.getMinutes().toString().padStart(2, '0');
            const timeString = `${hours}:${minutes}:00`;

            log(`üïê Heure actuelle locale: ${now.toLocaleTimeString('fr-FR')}`, 'info');
            log(`üéØ Heure de test configur√©e: ${timeString}`, 'info');

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/user_profiles?email=eq.${TEST_EMAIL}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SERVICE_ROLE_KEY,
                            'Authorization': `Bearer ${SERVICE_ROLE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            notification_time: timeString
                        })
                    }
                );

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                log(`‚úÖ Notification programm√©e pour: ${timeString}`, 'success');
                log('‚è≥ Attendre ~5 minutes pour la r√©ception...', 'info');
                markStepComplete(4);

            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                markStepError(4);
            }
        }

        async function triggerTestNotification() {
            log('üöÄ D√©clenchement manuel du syst√®me de notifications...', 'info');
            
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/functions/v1/cron-daily-notifications`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SERVICE_ROLE_KEY}`
                        },
                        body: JSON.stringify({
                            trigger: 'manual-test',
                            timestamp: new Date().toISOString()
                        })
                    }
                );

                const result = await response.json();

                if (!response.ok) {
                    log(`‚ùå Erreur HTTP ${response.status}`, 'error');
                    log(`<pre>${JSON.stringify(result, null, 2)}</pre>`, 'error');
                    markStepError(5);
                    return;
                }

                log('‚úÖ Cron d√©clench√© avec succ√®s', 'success');
                log(`<pre>${JSON.stringify(result, null, 2)}</pre>`, 'success');

                if (result.result?.notifications_sent > 0) {
                    log(`üéâ ${result.result.notifications_sent} notification(s) envoy√©e(s)!`, 'success');
                    log('üì± V√©rifiez votre appareil iOS', 'info');
                } else {
                    log('‚ö†Ô∏è Aucune notification envoy√©e', 'warning');
                    if (result.result?.errors?.length > 0) {
                        log(`Erreurs: <pre>${JSON.stringify(result.result.errors, null, 2)}</pre>`, 'error');
                    }
                }

                markStepComplete(5);

            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                markStepError(5);
            }
        }

        async function runAllSteps() {
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            log('üéØ EX√âCUTION DE TOUTES LES √âTAPES', 'info');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            
            completedSteps = 0;
            updateProgress();
            
            await createNotificationLogsTable();
            await new Promise(r => setTimeout(r, 1000));
            
            await checkUserConfig();
            await new Promise(r => setTimeout(r, 1000));
            
            await applyUserFixes();
            await new Promise(r => setTimeout(r, 1000));
            
            await setTestTime();
            await new Promise(r => setTimeout(r, 1000));
            
            await triggerTestNotification();
            
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            log('‚úÖ TOUTES LES √âTAPES TERMIN√âES', 'success');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
        }

        // Auto-check au chargement
        setTimeout(() => {
            log('üé¨ Interface pr√™te - Cliquez sur "EX√âCUTER TOUTES LES √âTAPES"', 'info');
        }, 500);
    </script>
</body>
</html>
